#!/usr/bin/env bash

# Copy/link this script to .git/hooks with (ln -s ../../.pre-commit .git/hooks/pre-commit)

ENV_NAME="supermodel_tool"
ENV_FILE_1="conda_env.yml"
ENV_FILE_2="conda_env_simple.yml"

# Save conda env
conda env export -n ${ENV_NAME} -f ${ENV_FILE_1}

# Save simplified conda env
conda env export -n ${ENV_NAME} -f ${ENV_FILE_2} --from-history

# Correct the simplified codna env - missing pip dependencies
if grep -q "pip:" ${ENV_FILE_1}; then 
    # Delete last line in conda_env_simple.yml
    sed -i -e '$d' ${ENV_FILE_2} 
    # Add pip dependencies to conda_env_simple.yml
    sed -n -e '/pip:/,$p' ${ENV_FILE_1} >> ${ENV_FILE_2}
fi

# Add to git history
git add ${ENV_FILE_1} ${ENV_FILE_2}

